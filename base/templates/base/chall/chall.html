{% extends 'main.html' %}
{% load static %}
{% block header_text %}
<span class="text">Challenge</span>
{% endblock header_text %}

{% block content %}
{% if request.path == "/chall/all/" %}

<!--Use the loop to clarify each category-->
{% for i in type_chall %}

<div class="container">
  <div class="row">
    <h2 style="text-align : center">{{i}}</h2>
    {% for j in chall %}
    {% if j.type == i %}
    <div class="col-md-2 col-sm-6" style="padding:30px 20px;">
      <div class="card card-block" data-bs-toggle="modal" data-bs-target="#exampleModal" chall-name="{{j.chall_name}}"
        chall-decription="{{j.decription}}" chall-link="{{j.link}} " chall-author="{{j.author}}" >
        <img src="{{j.img}}" alt="error" id='{{j.chall_name}}_img'>
        <h5 class="card-title  mt-2 mb-2 text-center " id='{{j.chall_name}}'>{{j.chall_name}}</h5>
        <h5 class="card-title  mt-2 mb-2 text-center">{{j.point}} points</h5>
      </div>
    </div>
    {% endif %}
    {% endfor %}
    {% endfor %}

    <!--when access each ctf's category-->
    {% elif request.path == "/chall/web/" %}
    <h2 style="text-align : center">Web Exploit</h2>
    <div class="container mt-1">
      <div class="row">
        {% for j in chall %}
        <div class="col-md-2 col-sm-6" style="padding:30px 20px;">
          <div class="card card-block" data-bs-toggle="modal" data-bs-target="#exampleModal" chall-name="{{j.chall_name}}"
            chall-decription="{{j.decription}}" chall-link="{{j.link}} " chall-author="{{j.author}}" >
            <img src="{{j.img}}" alt="error" id='{{j.chall_name}}_img'>
            <h5 class="card-title  mt-2 mb-2 text-center " id='{{j.chall_name}}'>{{j.chall_name}}</h5>
            <h5 class="card-title  mt-2 mb-2 text-center">{{j.point}} points</h5>
          </div>
        </div>
    {% endfor %}


    {% elif request.path == "/chall/crypto/" %}
    
    <h2 style="text-align : center">Cryptography</h2>
    <div class="container mt-1">
      <div class="row">
        {% for j in chall %}
        <div class="col-md-2 col-sm-6" style="padding:30px 20px;">
          <div class="card card-block" data-bs-toggle="modal" data-bs-target="#exampleModal" chall-name="{{j.chall_name}}"
            chall-decription="{{j.decription}}" chall-link="{{j.link}} " chall-author="{{j.author}}" >
            <img src="{{j.img}}" alt="error" id='{{j.chall_name}}_img'>
            <h5 class="card-title  mt-2 mb-2 text-center " id='{{j.chall_name}}'>{{j.chall_name}}</h5>
            <h5 class="card-title  mt-2 mb-2 text-center">{{j.point}} points</h5>
          </div>
        </div>
    {% endfor %}
    
    {% elif request.path == "/chall/pwn/"%}
    
    <h2 style="text-align : center">Pwnable</h2>
    <div class="container mt-1">
      <div class="row">
        {% for i in chall %}
        <div class="col-md-2 col-sm-6" style="padding:30px 20px;">
          <div class="card card-block" data-bs-toggle="modal" data-bs-target="#exampleModal" chall-name = "{{i.chall_name}}" chall-decription="{{i.decription}}" chall-link="{{i.link}}"  chall-author="{{i.author}}">
            <img src="{{i.img}}" alt="error" id='{{i.chall_name}}_img'>
            <h5 class="card-title  mt-2 mb-2 text-center" id="{{i.chall_name}}">{{i.chall_name}}</h5>
            <h5 class="card-title  mt-2 mb-2 text-center">{{i.point}} points</h5>
          </div>
        </div>
    {% endfor %}

    {% elif request.path == "/chall/re/"%}
    
    <h2 style="text-align : center">Reverse</h2>
    <div class="container mt-1">
      <div class="row">
        {% for i in chall %}
        <div class="col-md-2 col-sm-6" style="padding:30px 20px;">
          <div class="card card-block" data-bs-toggle="modal" data-bs-target="#exampleModal" chall-name = "{{i.chall_name}}" chall-decription="{{i.decription}}" chall-link="{{i.link}}"  chall-author="{{i.author}}">
            <img src="{{i.img}}" alt="error" id='{{i.chall_name}}_img'>
            <h5 class="card-title  mt-2 mb-2 text-center">{{i.chall_name}}</h5>
            <h5 class="card-title  mt-2 mb-2 text-center">{{i.point}} points</h5>
          </div>
        </div>
    {% endfor %}

    {% endif %}

    <!--Each modal when we click-->
    
    <form id="form-flag">  
    <div class="modal fade" id="exampleModal" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h1 class="modal-title fs-5"  id="challname"></h1>
          </div>
          <div class="modal-body">
            <!--each part os modal--> 
              <div class="mb-3">
                <h5>Decryption</h5>
                <p class="modal-decription"></p>
              </div>

              <div class="mb-3">
                <h5>Link</h5>
                <a class="modal-link"  href=""></a>
              </div>
              <div class="mb-3">
                <h5>Author</h5>
                <p class="modal-author"  href=""></p>
              </div>
              <div class="mb-3">
                <label for="flag" class="col-form-label">Flag:</label>
                <input type="text" class="form-control" id="flag">
              </div>
            
          </div>
          <!--two fuctions to  đóng và submit flag-->
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            <button type="submit" class="btn btn-primary">Submit</button>
          </div>
        </div>
      </div>
    </div>
</form>
<script src="https://cdn.jsdelivr.net/npm/js-cookie@2/src/js.cookie.min.js"></script>
    <script type="text/javascript">


      const exampleModal = document.getElementById('exampleModal')
      exampleModal.addEventListener('show.bs.modal', event => {
        // Button that triggered the modal
        const button = event.relatedTarget
        // Extract info from data-bs-* attributes
        const chall_name = button.getAttribute('chall-name')
        const decription = button.getAttribute('chall-decription')
        const link = button.getAttribute('chall-link')
        const author = button.getAttribute('chall-author')
        const modalTitle = exampleModal.querySelector('.modal-title')
        const modaldecription = exampleModal.querySelector('.modal-decription')
        const modalLink = exampleModal.querySelector('.modal-link')
        const modalAuthor = exampleModal.querySelector('.modal-author')
      
        modalTitle.textContent = chall_name
        modaldecription.textContent = decription
        modalLink.textContent = link
        modalAuthor.textContent = author


        const form = document.getElementById('form-flag')
        form.addEventListener('submit', event =>{
            var data = JSON.parse("{{data | escapejs}}")
            user_flag = document.getElementById('flag').value
            for(i in data){
              if(data[i].chall_name === chall_name)
              {
                

                  //alert(`${chall_name} have been sovle by {{request.user.team}}`)
                  var value = {
                    'point' : data[i].point,
                    'chall_name' : chall_name,
                    'user_flag' : user_flag,
                  }
                  fetch(`/chall/solved/`,{
                    method : 'POST',
                    body  : JSON.stringify(value),
                    headers : {
                      'Content-type' : 'application/json'
                    } 
                  }).then((res) => res.json())
                }
 
              
            }
            
        })



      })
      var data = JSON.parse("{{data | escapejs}}")
      for (i in data) {
        var team_solved = data[i].team_solved
        if(team_solved != '')
        {
          document.getElementById(data[i].chall_name).innerHTML = `<strike>${data[i].chall_name}</strike>`
          document.getElementById(`${data[i].chall_name}_img`).style.filter = 'blur(2px)'
        }
        else{
          
        }
      } 
    </script>
    {% endblock content %}

    {% block callfunc %}
    Modal_Card();
    {% endblock callfunc %}
  </div>
</div>